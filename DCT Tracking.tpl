___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "DCT Tracking",
  "brand": {
    "id": "github.com_taneli-salonen1",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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eviy6x1DYzVutlzkidWPElQ5zWyGV3HiS4HjxP3qBRBMVmp71WxVMVRXPcypqW1UoDWt3pQMB2QOBx4L6l1ZfZr/ABX6W4PddIgAyoLG5GBgcMY5HwUKiCcsWrr9YHVBtNwdAKlwfK0xse1zv7W64EA+YX1atZ6itFwrLhb7rPHVVpzUvcGv6U5yCQ4EZGTg44Z4KBRB6bhXVVzrZq2vnkqKmZ29JLIclxU1ctd6oulp+i6+81E1GQGuY4NDngcg54G873krnEQTUWqr3FPBPHXuEkFD1CN243s0/HscuXE8ea9MWutSxWYWeO6OFvEBgEPRRnEZBBGd3PInvXOIglxqa8i50NybXPbWUETIaWRrWjomNBDWgYxjBPd3rzz3m4T211tlqM0bqo1ZhDGgdMRul3AeHDHJeBEElPfbnPV2+rlq3mot0UUVI/ABibGcsAwO7zXpj1bfo9QyagZcHi6yDD6ksaSRu7vLGOQA5KERBK3/AFFddRTxT3mrNTJEzcY4xtbgZzjsgKKREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQf//Z"
  },
  "description": "Dentsu Creative",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "accountId",
    "displayName": "Account Id",
    "simpleValueType": true,
    "help": "Enter Account Id",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "dcId",
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "campaignId",
    "displayName": "Campaign Id",
    "simpleValueType": true,
    "help": "Enter the dcCid value from Dentsu. Leave blank if the value in the tracking code is blank.",
    "valueHint": "dcCid",
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "hostname",
    "displayName": "Tracking Hostname",
    "simpleValueType": true,
    "help": "Enter the hostname value from the Pardot tracking script.",
    "valueHint": "hostname",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "trackingOptInEnabled",
    "displayName": "Pardot Tracking Opt-in Enabled?",
    "radioItems": [
      {
        "value": true,
        "displayValue": "True",
        "subParams": [
          {
            "type": "TEXT",
            "name": "piOptIn",
            "displayName": "PI Opt-in",
            "simpleValueType": true,
            "alwaysInSummary": false,
            "help": "Has the visitor given consent? Use a GTM variable: \"true\" / \"false\"",
            "valueValidators": []
          }
        ],
        "help": ""
      },
      {
        "value": false,
        "displayValue": "False"
      }
    ],
    "simpleValueType": true,
    "defaultValue": true,
    "help": "Has tracking opt-in been enabled in Pardot settings?"
  },
  {
    "type": "LABEL",
    "name": "optInInfo1",
    "displayName": "Note when setting Pardot Tracking Opt-in:"
  },
  {
    "type": "LABEL",
    "name": "optInInfo2",
    "displayName": "Pardot by default does not support changing an already set consent choice. Firing the tag again with a different value would not change the setting."
  },
  {
    "type": "LABEL",
    "name": "optInInfo3",
    "displayName": "However, Pardot can change a setting in the account that allows for changing the consent setting from the tag. See this link: https://help.salesforce.com/articleView?id\u003d000313156\u0026language\u003den_US\u0026type\u003d1\u0026mode\u003d1"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/*
Custom Pardot tracking code template for making GET requests to the Pardot analytics server.
Created by: Taneli Salonen, taneli.salonen@fluidogroup.com

Known functionality that's missing:
- Can't run JS code upon response like the original tracking code does. The pd.js code runs a script to set the visitor id as a local JS cookie upon response. This is an addition to the server side cookie that the response sets.
- Missing analytics params: pi_points, pi_include_in_activies, read from global variables: piIncludeInActivities & piProfileId
*/

// Required functions
const log = require('logToConsole');
const getType = require('getType');
const makeString = require('makeString');
const makeNumber = require('makeNumber');
const getUrl = require('getUrl');
const getReferrerUrl = require('getReferrerUrl');
const readTitle = require('readTitle');
const encodeUriComponent = require('encodeUriComponent');
const sendPixel = require('sendPixel');
const getCookieValues = require('getCookieValues');
const getQueryParameters = require('getQueryParameters');

// Check that the main inputs are valid
if (data.accountId && (getType(data.accountId) === 'number' || getType(data.accountId) === 'string') && makeNumber(data.accountId) > 0) {
  
  // Basic parameters included in every request
  const accountId = makeString(data.accountId);
  const campaignId = data.campaignId ? 
        makeString(data.campaignId) : getQueryParameters('pi_campaign_id', false) ? 
        getQueryParameters('pi_campaign_id', false): '';
  const hostname = data.hostname;
  const host = getUrl('host');
  const protocol = getUrl('protocol');
  const referrer = getReferrerUrl() ? getReferrerUrl() : '';
  const url = getUrl() ? getUrl() : '';
  const title = readTitle() ? readTitle() : '';
  
  // Opt-in parameter
  let piOptIn = data.trackingOptInEnabled ? '': null;
  if (data.trackingOptInEnabled && (data.piOptIn === 'true' || data.piOptIn === true)) {
    piOptIn = 'true';
  } else if (data.trackingOptInEnabled && (data.piOptIn === 'false' || data.piOptIn === false)) {
    piOptIn = 'false';
  }
 
  // Tracking endpoint base URL
  const analyticsHostname = (data.hostname === 'pi.pardot.com' && protocol === 'http') ? 'cdn.pardot.com' : data.hostname;
  const baseUrl = protocol + '://' + analyticsHostname + '/track?';
  
  const commonParams = [
    ['ver', '1'],
    ['campaign_id', campaignId],
    ['account_id', accountId],
    ['title', title],
    ['page_url', url],
    ['host', host],
    ['referrer', referrer]
  ];

  // These parameters are just captured from the current page's URL as they are
  const urlParams = [
    'pi_ad_id',
    'creative',
    'matchtype',
    'keyword',
    'network',
    'pi_profile_id',
    'pi_email',
    'pi_list_email',
    'utm_campaign',
    'utm_medium',
    'utm_source',
    'utm_content',
    'gclid',
    'device'
  ].map(function(param) {
    return [param, getQueryParameters(param, false)];
  });
  
  // Special logic params from page URL
  const specialUrlParams = [
    ['utm_term', getQueryParameters('utm_term', false) ? getQueryParameters('utm_term', false) : getQueryParameters('_kk', false)]
  ];
  
  // Get only the params that have a string value and join them into the payload.
  // Encode the values of the parameters
  const concatParams = commonParams.concat(urlParams).concat(specialUrlParams);
  const hitParams = concatParams.filter(function(param) {
    return getType(param[1]) === 'string';
  }).map(function(param) {
    return param[0] + '=' + encodeUriComponent(param[1]);
  }).join('&');
  
  // Construct the final tracking 
  const trackingUrl = baseUrl + hitParams;
  //log(trackingUrl);
  
  sendPixel(trackingUrl, data.gtmOnSuccess(), data.gtmOnFailure());
}

data.gtmOnFailure();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_title",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://dentsu-tracking-dev.flexintelligent.com/"
              },
              {
                "type": 1,
                "string": "https://dentsu-tracking-dev.flexintelligent.com/track"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_dcc"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Basic test
  code: |-
    const mockData = {
      accountId: '90244',
      campaignId: null,
      hostname: 'dentsu-tracking-dev.flexintelligent.com',
      trackingOptInEnabled: true,
      piOptIn: 'true'
    };

    const pageUrl = 'https://www.fluidogroup.com?utm_campaign=test';

    log('testing');

    mock('getUrl', (part) => {
      if (part === 'protocol') {
        return 'https';
      }
      return pageUrl;
    });

    mock('getQueryParameters', (param, retrieveAll) => {
      const url = pageUrl;
      const parts = url.split('?');
      if (parts.length > 1) {
        const query = parts[1];
        const params = query.split('&');
        for (var i = 0; i < params.length; i++) {
          if (params[i].indexOf(param) === 0) {
            log('param: ' + params[i].split('=')[1]);
            return params[i].split('=')[1];
          }
        }
      }
      return null;
    });

    mock('getReferrerUrl', () => {
      return 'https://www.google.com';
    });

    mock('readTitle', () => {
      return 'Page title';
    });

    const variableResult = [];

    mock('sendPixel', (url, onSuccess, onFailure) => {
      log('url : '  + url);
      const params = url.split('?')[1].split('&');
      params.forEach(param => {
        variableResult.push(param);
      });
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    log(variableResult);

    const expectedResult = [];

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: const log = require('logToConsole');


___NOTES___

Created on 5.2.2021 klo 12.32.11


